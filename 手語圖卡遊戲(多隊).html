<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手語圖卡遊戲</title>
    <!-- 引入 Tailwind CSS 框架 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles to ensure images fill their container and maintain aspect ratio */
        .card-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
            margin: auto;
            cursor: pointer; /* Add pointer to indicate clickability */
        }
        /* Hide native file input and replace with a custom button */
        .file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        /* Modal overlay for enlarged image */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }

        .modal-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .close-button {
            position: absolute;
            top: 1rem;
            right: 2rem;
            color: white;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
    <!-- Phosphor Icons for mute/unmute icon -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1/dist/phosphor.js"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-4xl w-full flex flex-col items-center space-y-6 mb-8">
        <!-- Game Section -->
        <h1 class="text-3xl font-bold text-gray-800">手語圖卡遊戲</h1>
        
        <!-- Re-arranged Controls and Scoreboard Section -->
        <div class="w-full flex flex-col lg:flex-row items-center justify-between space-y-4 lg:space-y-0 lg:space-x-4">
            
            <!-- Left-side Controls -->
            <div class="flex-1 flex flex-col items-center lg:items-start space-y-4 w-full lg:w-auto">
                <div class="flex flex-wrap items-center space-x-4 space-y-2 lg:space-y-0 w-full justify-center lg:justify-start">
                    <div class="flex items-center space-x-2">
                        <label for="cardTimerInput" class="text-gray-700 whitespace-nowrap">計時 (秒):</label>
                        <input type="number" id="cardTimerInput" class="w-16 p-2 rounded-md border border-gray-300 text-center" min="1" max="60" value="10">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="bonusInput" class="text-gray-700 whitespace-nowrap">加分 (0-5):</label>
                        <input type="number" id="bonusInput" class="w-16 p-2 rounded-md border border-gray-300 text-center" min="0" max="5" value="0">
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="teamCountInput" class="text-gray-700 whitespace-nowrap">隊伍數 (1-8):</label>
                        <input type="number" id="teamCountInput" class="w-16 p-2 rounded-md border border-gray-300 text-center" min="1" max="8" value="2">
                    </div>
                </div>
                
                <div class="flex flex-wrap items-center space-x-4 space-y-2 lg:space-y-0 w-full justify-center lg:justify-start">
                    <!-- Pause/Continue Button -->
                    <button id="pauseBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-colors transform disabled:bg-gray-400 disabled:cursor-not-allowed text-sm">
                        暫停
                    </button>
                    <!-- Volume Control -->
                    <div class="flex items-center space-x-2">
                        <i id="volumeIcon" class="ph ph-speaker-simple-high text-2xl text-gray-700 cursor-pointer"></i>
                        <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="1" class="w-24 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <!-- File Input Button -->
                    <input type="file" id="folderInput" class="file-input" webkitdirectory directory multiple>
                    <label for="folderInput" class="cursor-pointer bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-colors text-sm">
                        選取圖卡
                    </label>
                </div>
            </div>
            
            <!-- Right-side Scoreboard -->
            <div class="flex-1 flex flex-col items-center lg:items-end w-full lg:w-auto">
                <div id="scoreboardContainer" class="w-full flex justify-around items-center bg-gray-200 rounded-lg mb-2 p-2 flex-wrap">
                    <!-- Scoreboard items will be generated here by JavaScript -->
                </div>
                <button id="switchTeamBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-colors transform disabled:bg-gray-400 disabled:cursor-not-allowed text-sm">
                    手動切換隊伍
                </button>
            </div>
        </div>
        
        <p id="timerDisplay" class="text-4xl font-mono text-gray-800 hidden">00:00</p>
        <p id="timerMessage" class="text-red-500 text-sm h-6"></p>

        <div id="cardContainer" class="flex flex-col items-center justify-around bg-white rounded-xl p-4 w-full h-96 overflow-hidden shadow-inner space-y-4">
            <span class="text-gray-500 text-lg text-center">
                請選擇一個資料夾，然後點擊「下一張」按鈕。
            </span>
        </div>
        
        <div class="flex flex-wrap justify-center space-x-4 space-y-4 sm:space-y-0">
            <button id="correctBtn" class="bg-lime-500 hover:bg-lime-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-colors transform disabled:bg-gray-400 disabled:cursor-not-allowed">
                答對
            </button>
            <button id="wrongBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-colors transform disabled:bg-gray-400 disabled:cursor-not-allowed">
                答錯
            </button>
            <button id="skipBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-colors transform disabled:bg-gray-400 disabled:cursor-not-allowed">
                跳過
            </button>
            <button id="nextCardBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-colors transform disabled:bg-gray-400 disabled:cursor-not-allowed">
                下一張
            </button>
            <button id="restartBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-colors transform disabled:bg-gray-400 disabled:cursor-not-allowed">
                重新開始
            </button>
        </div>
        
        <p id="message" class="text-sm text-gray-700 h-6"></p>
        <p id="scoreDisplay" class="text-lg font-bold text-gray-800 hidden">得分: 0 | 跳過: 0 | 總計: 0</p>
    </div>
    
    <!-- Modal for enlarged image -->
    <div id="imageModal" class="modal">
        <span class="close-button" id="closeModalBtn">&times;</span>
        <img class="modal-image" id="enlargedImage" />
    </div>
    
    <script>
        const folderInput = document.getElementById('folderInput');
        const cardContainer = document.getElementById('cardContainer');
        const nextCardBtn = document.getElementById('nextCardBtn');
        const correctBtn = document.getElementById('correctBtn');
        const wrongBtn = document.getElementById('wrongBtn');
        const skipBtn = document.getElementById('skipBtn');
        const restartBtn = document.getElementById('restartBtn');
        const message = document.getElementById('message');
        const imageModal = document.getElementById('imageModal');
        const enlargedImage = document.getElementById('enlargedImage');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cardTimerInput = document.getElementById('cardTimerInput');
        const bonusInput = document.getElementById('bonusInput');
        const teamCountInput = document.getElementById('teamCountInput');
        const timerDisplay = document.getElementById('timerDisplay');
        const timerMessage = document.getElementById('timerMessage');
        const pauseBtn = document.getElementById('pauseBtn');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeIcon = document.getElementById('volumeIcon');
        const scoreboardContainer = document.getElementById('scoreboardContainer');
        const switchTeamBtn = document.getElementById('switchTeamBtn');

        const defaultAudioPath = 'https://raw.githubusercontent.com/sunylin/signlanguage/main/超級比一比.mp3';

        let deck = [];
        let backgroundMusic = null;
        let isPaused = false;
        let originalVolume = 1;
        let currentCardIndex = 0;
        let timerInterval;
        let timerStarted = false;
        let timeLeft = 0; 
        let initialDeck = []; 
        let teamScores = [];
        let currentTeamIndex = 0;

        correctBtn.disabled = true;
        wrongBtn.disabled = true;
        skipBtn.disabled = true;
        restartBtn.disabled = true;
        pauseBtn.disabled = true;
        switchTeamBtn.disabled = true;

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function createScoreboard() {
            const teamCount = parseInt(teamCountInput.value, 10);
            if (isNaN(teamCount) || teamCount < 1 || teamCount > 8) {
                teamCountInput.value = 2;
                return;
            }
            teamScores = new Array(teamCount).fill(0);
            scoreboardContainer.innerHTML = '';
            teamScores.forEach((score, index) => {
                const teamContainer = document.createElement('div');
                teamContainer.id = `team${index + 1}Container`;
                teamContainer.className = 'text-center border-4 border-transparent rounded-lg p-2 transition-colors flex-1 min-w-[6rem]';
                const teamName = document.createElement('h3');
                teamName.className = 'text-md font-bold text-gray-700';
                teamName.textContent = `第 ${index + 1} 隊`;
                const teamScoreEl = document.createElement('p');
                teamScoreEl.id = `team${index + 1}Score`;
                teamScoreEl.className = 'text-2xl font-mono text-gray-800';
                teamScoreEl.textContent = score;
                teamContainer.appendChild(teamName);
                teamContainer.appendChild(teamScoreEl);
                scoreboardContainer.appendChild(teamContainer);
            });
            updateTeamHighlight();
        }

        function updateScores() {
            teamScores.forEach((score, index) => {
                const teamScoreEl = document.getElementById(`team${index + 1}Score`);
                if (teamScoreEl) {
                    teamScoreEl.textContent = score;
                }
            });
        }

        function updateTeamHighlight() {
            const teamContainers = scoreboardContainer.children;
            for (let i = 0; i < teamContainers.length; i++) {
                if (i === currentTeamIndex) {
                    teamContainers[i].classList.add('border-purple-500');
                    teamContainers[i].classList.remove('border-transparent');
                } else {
                    teamContainers[i].classList.add('border-transparent');
                    teamContainers[i].classList.remove('border-purple-500');
                }
            }
        }

        function endGame() {
            clearInterval(timerInterval);
            timerDisplay.classList.add('hidden');
            correctBtn.disabled = true;
            wrongBtn.disabled = true;
            skipBtn.disabled = true;
            nextCardBtn.disabled = true;
            pauseBtn.disabled = true;
            switchTeamBtn.disabled = true;
            pauseBtn.textContent = '暫停';
            cardTimerInput.disabled = false;
            teamCountInput.disabled = false;
            cardContainer.innerHTML = `<span class="text-blue-500 text-2xl font-bold text-center">恭喜！本次練習已結束。</span>`;
            message.textContent = `最終分數：${teamScores.map((score, index) => `第 ${index + 1} 隊: ${score}`).join(' | ')}`;
            if (backgroundMusic) {
                backgroundMusic.pause();
            }
        }

        function startTimer() {
            if (timeLeft === 0) {
                const totalSeconds = parseInt(cardTimerInput.value, 10);
                if (isNaN(totalSeconds) || totalSeconds <= 0 || totalSeconds > 60) {
                    timerMessage.textContent = '請輸入一個有效時間（1到60秒）。';
                    endGame();
                    return;
                }
                timeLeft = totalSeconds;
            }
            
            clearInterval(timerInterval);
            cardTimerInput.disabled = true;
            teamCountInput.disabled = true;
            switchTeamBtn.disabled = true;

            const updateTimerDisplay = () => {
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = '00:00';
                    teamScores[currentTeamIndex] -= 1;
                    bonusInput.value = 0;
                    currentTeamIndex = (currentTeamIndex + 1) % teamScores.length;
                    updateScores();
                    updateTeamHighlight();
                    prepareNextCard();
                    return;
                }

                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                timeLeft--;
            };

            isPaused = false;
            timerDisplay.classList.remove('hidden');
            updateTimerDisplay(); 
            timerInterval = setInterval(updateTimerDisplay, 1000);
            timerStarted = true;
            pauseBtn.textContent = '暫停';
            if (backgroundMusic) {
                backgroundMusic.play();
            }
        }

        function showCurrentCard() {
            if (deck.length === 0) return;
            const currentCard = deck[currentCardIndex];
            const cardDisplay = document.createElement('div');
            cardDisplay.className = 'flex flex-col items-center justify-around space-y-4 h-full w-full';
            const nameText = document.createElement('h3');
            nameText.className = 'text-3xl font-bold text-gray-800';
            nameText.textContent = currentCard.name;
            const img = document.createElement('img');
            img.src = currentCard.url;
            img.alt = `手語圖卡 ${currentCardIndex + 1}`;
            img.className = 'card-image flex-grow';
            img.addEventListener('click', () => {
                enlargedImage.src = currentCard.url;
                imageModal.style.display = 'flex';
            });
            cardDisplay.appendChild(nameText);
            cardDisplay.appendChild(img);
            cardContainer.innerHTML = '';
            cardContainer.appendChild(cardDisplay);
        }
        
        function prepareNextCard() {
            clearInterval(timerInterval);
            correctBtn.disabled = true;
            wrongBtn.disabled = true;
            skipBtn.disabled = true;
            nextCardBtn.disabled = false;
            switchTeamBtn.disabled = false;
            
            if (backgroundMusic) {
                backgroundMusic.pause();
            }

            if (currentCardIndex < deck.length - 1) {
                currentCardIndex++;
                message.textContent = `第 ${currentCardIndex} 張已完成。請按「下一張」繼續。`;
                cardContainer.innerHTML = `<span class="text-gray-500 text-lg text-center">準備好了嗎？</span>`;
                timeLeft = 0;
            } else {
                endGame();
            }
        }
        
        folderInput.addEventListener('change', async (event) => {
            const files = event.target.files;
            
            if (backgroundMusic) {
                backgroundMusic.pause();
                backgroundMusic = null;
            }

            deck = [];
            currentCardIndex = 0;
            currentTeamIndex = 0;
            createScoreboard();
            updateScores();
            timerStarted = false;
            clearInterval(timerInterval);
            timerDisplay.classList.add('hidden');
            
            if (files.length === 0) {
                message.textContent = '未選擇任何檔案。';
                correctBtn.disabled = true;
                wrongBtn.disabled = true;
                skipBtn.disabled = true;
                restartBtn.disabled = true;
                pauseBtn.disabled = true;
                cardTimerInput.disabled = false;
                teamCountInput.disabled = false;
                switchTeamBtn.disabled = true;
                nextCardBtn.disabled = true;
                return;
            }
            
            let foundAudio = null;

            for (const file of files) {
                const fileNameWithoutExt = file.name.replace(/\.[^/.]+$/, "");
                if (file.type.startsWith('image/')) {
                    deck.push({ url: URL.createObjectURL(file), name: fileNameWithoutExt });
                } else if (file.type.startsWith('audio/') && !foundAudio) {
                    foundAudio = URL.createObjectURL(file);
                }
            }

            if (deck.length === 0) {
                message.textContent = '資料夾中沒有圖片檔案。';
                correctBtn.disabled = true;
                wrongBtn.disabled = true;
                skipBtn.disabled = true;
                nextCardBtn.disabled = true;
            } else {
                initialDeck = [...deck];
                shuffle(deck);
                message.textContent = `已載入 ${deck.length} 張圖卡，點擊「下一張」來開始遊戲。`;
                
                cardContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center space-y-4">
                        <span class="text-gray-500 text-lg text-center">準備好了嗎？</span>
                        <p class="text-gray-500 text-sm text-center">
                        答對：加 2 分。答錯：扣 1 分。時間到：扣 1 分。
                    </p>
                </div>
            `;
                
                correctBtn.disabled = true;
                wrongBtn.disabled = true;
                skipBtn.disabled = true;
                nextCardBtn.disabled = false;
                restartBtn.disabled = false;
                pauseBtn.disabled = false;
                cardTimerInput.disabled = false;
                teamCountInput.disabled = false;
                switchTeamBtn.disabled = true;
                
                try {
                    backgroundMusic = new Audio(defaultAudioPath);
                    backgroundMusic.loop = true;
                    backgroundMusic.volume = volumeSlider.value;
                } catch (e) {
                    console.error("預設音訊檔路徑無效:", e);
                    if (foundAudio) {
                        backgroundMusic = new Audio(foundAudio);
                        backgroundMusic.loop = true;
                        backgroundMusic.volume = volumeSlider.value;
                    }
                }
            }
        });

        nextCardBtn.addEventListener('click', () => {
            if (currentCardIndex < deck.length) {
                showCurrentCard();
                startTimer();
                nextCardBtn.disabled = true;
                correctBtn.disabled = false;
                wrongBtn.disabled = false;
                skipBtn.disabled = false;
            } else {
                endGame();
            }
        });

        correctBtn.addEventListener('click', () => {
            const bonus = parseInt(bonusInput.value, 10) || 0;
            teamScores[currentTeamIndex] += 2 + bonus;
            bonusInput.value = 0;
            currentTeamIndex = (currentTeamIndex + 1) % teamScores.length;
            updateScores();
            updateTeamHighlight();
            prepareNextCard();
        });

        wrongBtn.addEventListener('click', () => {
            teamScores[currentTeamIndex] -= 1;
            bonusInput.value = 0;
            currentTeamIndex = (currentTeamIndex + 1) % teamScores.length;
            updateScores();
            updateTeamHighlight();
            prepareNextCard();
        });

        skipBtn.addEventListener('click', () => {
            bonusInput.value = 0;
            prepareNextCard();
        });
        
        switchTeamBtn.addEventListener('click', () => {
            if (isPaused) {
                currentTeamIndex = (currentTeamIndex + 1) % teamScores.length;
                updateTeamHighlight();
                // Reset timer for the new team
                timeLeft = parseInt(cardTimerInput.value, 10);
                timerDisplay.textContent = `${String(Math.floor(timeLeft / 60)).padStart(2, '0')}:${String(timeLeft % 60).padStart(2, '0')}`;
                message.textContent = `已切換至：第 ${currentTeamIndex + 1} 隊，計時器已重設。`;
            }
        });

        restartBtn.addEventListener('click', () => {
            clearInterval(timerInterval);
            timerStarted = false;
            isPaused = false;
            currentCardIndex = 0;
            currentTeamIndex = 0;
            createScoreboard();
            timeLeft = 0;
            updateScores();
            updateTeamHighlight();
            deck = [...initialDeck];
            shuffle(deck);
            timerDisplay.classList.add('hidden');
            timerMessage.textContent = '';
            message.textContent = `已載入 ${deck.length} 張圖卡，點擊「下一張」來開始遊戲。`;
            cardContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center space-y-4">
                    <span class="text-gray-500 text-lg text-center">準備好了嗎？</span>
                    <p class="text-gray-500 text-sm text-center">
                        答對：加 2 分。答錯：扣 1 分。時間到：扣 1 分。
                    </p>
                </div>
            `;
            correctBtn.disabled = true;
            wrongBtn.disabled = true;
            skipBtn.disabled = true;
            nextCardBtn.disabled = false;
            pauseBtn.disabled = false;
            switchTeamBtn.disabled = true;
            pauseBtn.textContent = '暫停';
            cardTimerInput.disabled = false;
            teamCountInput.disabled = false;
            updateScores();
            if (backgroundMusic) {
                backgroundMusic.pause();
                backgroundMusic.currentTime = 0;
            }
        });
        
        pauseBtn.addEventListener('click', () => {
            if (isPaused) {
                // User is clicking "Continue"
                startTimer();
                pauseBtn.textContent = '暫停';
                correctBtn.disabled = false;
                wrongBtn.disabled = false;
                skipBtn.disabled = false;
                nextCardBtn.disabled = true; // '下一張' button should be disabled when timer is running
                switchTeamBtn.disabled = true;
            } else {
                // User is clicking "Pause"
                clearInterval(timerInterval);
                isPaused = true;
                pauseBtn.textContent = '繼續';
                correctBtn.disabled = true;
                wrongBtn.disabled = true;
                skipBtn.disabled = true;
                nextCardBtn.disabled = false; // '下一張' button is enabled when the game is paused
                switchTeamBtn.disabled = false;
                if (backgroundMusic) {
                    backgroundMusic.pause();
                }
            }
        });

        volumeSlider.addEventListener('input', (event) => {
            if (backgroundMusic) {
                backgroundMusic.volume = event.target.value;
                if (backgroundMusic.volume === 0) {
                    volumeIcon.className = 'ph ph-speaker-simple-slash text-2xl text-gray-700 cursor-pointer';
                } else {
                    volumeIcon.className = 'ph ph-speaker-simple-high text-2xl text-gray-700 cursor-pointer';
                }
            }
        });

        volumeIcon.addEventListener('click', () => {
            if (backgroundMusic) {
                if (backgroundMusic.volume > 0) {
                    originalVolume = backgroundMusic.volume;
                    backgroundMusic.volume = 0;
                    volumeSlider.value = 0;
                    volumeIcon.className = 'ph ph-speaker-simple-slash text-2xl text-gray-700 cursor-pointer';
                } else {
                    backgroundMusic.volume = originalVolume;
                    volumeSlider.value = originalVolume;
                    volumeIcon.className = 'ph ph-speaker-simple-high text-2xl text-gray-700 cursor-pointer';
                }
            }
        });

        closeModalBtn.addEventListener('click', () => {
            imageModal.style.display = 'none';
        });

        imageModal.addEventListener('click', (event) => {
            if (event.target === imageModal) {
                imageModal.style.display = 'none';
            }
        });
        
        teamCountInput.addEventListener('change', () => {
            createScoreboard();
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'ArrowRight' || event.key === ' ' || event.key === 'Enter') {
                if (!correctBtn.disabled) {
                    correctBtn.click();
                }
            } else if (event.key === 'ArrowLeft') {
                if (!wrongBtn.disabled) {
                    wrongBtn.click();
                }
            } else if (event.key === 'ArrowDown') {
                if (!skipBtn.disabled) {
                    skipBtn.click();
                }
            }
        });
        
        // Initial setup
        createScoreboard();
    </script>
</body>
</html>
